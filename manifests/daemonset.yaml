---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: bridge-filtering
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: bridge-filtering
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: bridge-filtering
subjects:
- kind: ServiceAccount
  name: bridge-filtering
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bridge-filtering
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: bridge-filtering-ds
  namespace: kube-system
  labels:
    tier: node
    app: bridge-filtering
    name: bridge-filtering
spec:
  selector:
    matchLabels:
      name: bridge-filtering
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        tier: node
        app: bridge-filtering
        name: bridge-filtering
    spec:
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      serviceAccountName: bridge-filtering
      initContainers:
      - name: bridge-filtering-copier
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        env:
        - name: CNI_NAME
          value: bridge-filtering
        - name: CNI_CONF_DIR
          value: "/host/etc/cni/net.d"
        - name: KUBECONFIG_PATH
          value: "/etc/cni/net.d/bridge-filtering.d/bridge-filtering.kubeconfig"
        - name: SCRIPT
          value: "IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpzdGRpbj0kKGNhdCAvZGV2L3N0ZGluKQpsb2dGaWxlPSIke0xPR0ZJTEU6LS92YXIvbG9nL2JyaWRnZS1maWx0ZXJpbmcubG9nfSIKCktVQkVDT05GSUdfUEFUSD0iJHtLVUJFQ09ORklHX1BBVEg6LS9ldGMvY25pL25ldC5kL2JyaWRnZS1maWx0ZXJpbmcuZC9icmlkZ2UtZmlsdGVyaW5nLmt1YmVjb25maWd9IgpDTklfVkVSU0lPTj0iJChlY2hvICIkc3RkaW4iIHwganEgLXIgIi5jbmlWZXJzaW9uIikiCkNOSV9QUkVWX1JFU1VMVD0iJChlY2hvICIkc3RkaW4iIHwganEgLWNyICIucHJldlJlc3VsdCIpIgoKZXhlYyAyPj4gJGxvZ0ZpbGUKCk5GVF9CUklER0VfVEFCTEU9YnJpZGdlCk5GVF9UQUJMRT1maWx0ZXIKCk5GVF9JTkdSRVNTX0NIQUlOPXByZXJvdXRpbmcKTkZUX0lOR1JFU1NfSE9PSz1wcmVyb3V0aW5nCgpORlRfUE9TVFJPVVRJTkdfQ0hBSU49cG9zdHJvdXRpbmcKTkZUX0VHUkVTU19IT09LPXBvc3Ryb3V0aW5nCgpnZXRfb2JqZWN0KCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtY3IgIiRqc29uX3BhdGgiCn0KCmdldF9hcnJheV9pdGVtcygpIHsKICAgIGxvY2FsIGpzb25fb2JqZWN0PSIkMSIKICAgIGxvY2FsIGpzb25fcGF0aD0iJDIiCiAgICBlY2hvICIkanNvbl9vYmplY3QiIHwganEgLWMgJGpzb25fcGF0aCB8IGpxIC1jciAiLltdIgp9CgpnZXRfYXJyYXlfbGVuKCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtYyAiJGpzb25fcGF0aCIgfCBqcSAiLiB8IGxlbmd0aCIKfQoKZm9yX2pzb25fYXJyYXkoKSB7CiAgICBsb2NhbCBqc29uX29iamVjdD0iJDEiCiAgICBsb2NhbCBqc29uX3BhdGg9IiQyIgogICAgbG9jYWwgZm49IiQzIgogICAgZm9yIGl0ZW0gaW4gJChnZXRfYXJyYXlfaXRlbXMgIiRqc29uX29iamVjdCIgIiRqc29uX3BhdGgiKTsgZG8KICAgICAgICAkZm4gJGl0ZW0KICAgIGRvbmUKfQoKZ2V0X2lwX3ZlcnNpb24oKSB7CiAgICBsb2NhbCBpcF9hZGRyZXNzPSIkMSIKICAgIGlmIFtbICIkaXBfYWRkcmVzcyIgPX4gLio6LiogXV0KICAgIHRoZW4KICAgICAgICBlY2hvICJpcDYiCiAgICBlbHNlCiAgICAgICAgZWNobyAiaXAiCiAgICBmaQp9CgpjcmVhdGVfdGFibGUoKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgZWNobyAibmZ0IGFkZCB0YWJsZSAkdHlwZSAkbmFtZSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX25ldGRldl9iYXNlX2NoYWluKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGxvY2FsIGNoYWluPSIkMyIKICAgIGxvY2FsIGhvb2s9IiQ0IgogICAgbG9jYWwgZGV2aWNlPSIkNSIKICAgIGVjaG8gIm5mdCBhZGQgY2hhaW4gJHR5cGUgJG5hbWUgJGNoYWluIHsgdHlwZSBmaWx0ZXIgaG9vayAkaG9vayBkZXZpY2UgJGRldmljZSBwcmlvcml0eSAtMTsgcG9saWN5IGFjY2VwdDsgfSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX2Jhc2VfY2hhaW4oKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgbG9jYWwgY2hhaW49IiQzIgogICAgbG9jYWwgaG9vaz0iJDQiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiB7IHR5cGUgZmlsdGVyIGhvb2sgJGhvb2sgcHJpb3JpdHkgLTE7IHBvbGljeSBhY2NlcHQ7IH0iIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9jaGFpbigpIHsKICAgIGxvY2FsIHR5cGU9IiQxIgogICAgbG9jYWwgbmFtZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKbmZ0X2FkZF9ydWxlKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCB0YWJsZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBzZXQgLS0gIiR7QDo0fSIKICAgIGVjaG8gIm5mdCBhZGQgcnVsZSAkdHlwZSAkdGFibGUgJGNoYWluICRAIiB8IHRlZSAtYSAkbG9nRmlsZQp9CgpjcmVhdGVfcnVsZXNfZm9yX2ZpbHRlcmluZygpIHsKICAgIGxvY2FsIGNvbmZpZ19pZD0iJDEiCiAgICBsb2NhbCBjb25maWc9IiQyIgogICAgbG9jYWwgdGFibGVfdHlwZT0iJDMiCiAgICBsb2NhbCBkaXJlY3Rpb249IiQ0IgoKICAgIGxvY2FsIG1hdGNoX2FkZHI9InNhZGRyIgogICAgaWYgW1sgIiRkaXJlY3Rpb24iID09ICJlZ3Jlc3MiIF1dOyB0aGVuCiAgICAgICAgbG9jYWwgbWF0Y2hfYWRkcj0iZGFkZHIiCiAgICBmaQogICAgbG9jYWwgbWF0Y2hfaWZhY2U9ImlpZm5hbWUiCiAgICBpZiBbWyAiJGRpcmVjdGlvbiIgPT0gImVncmVzcyIgXV07IHRoZW4KICAgICAgICBtYXRjaF9pZmFjZT0ib2lmbmFtZSIKICAgIGZpCgogICAgX2NyZWF0ZV9maWx0ZXJpbmdfY2hhaW4oKSB7CiAgICAgICAgbG9jYWwgY29uZmlnX2lkPSIkMSIKICAgICAgICBsb2NhbCBjb25maWc9IiQyIgogICAgICAgIGxvY2FsIHRhYmxlX3R5cGU9IiQzIgogICAgICAgIGxvY2FsIGRpcmVjdGlvbj0iJDQiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259IikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7ZGlyZWN0aW9ufSIgIiR7bWF0Y2hfaWZhY2V9IiAiJENOSV9JRk5BTUUiIGNvdW50ZXIganVtcCAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAiJiIgMHhmZmZjZmZmZikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgogICAgfQoKICAgIF9jcmVhdGVfc3VibmV0X3J1bGUoKSB7CiAgICAgICAgbG9jYWwgc3VibmV0PSQxCiAgICAgICAgaWYgW1sgIiQoZ2V0X29iamVjdCAiJHtzdWJuZXR9IiAiLmV4Y2VwdCIpIiAhPSAibnVsbCIgXV07IHRoZW4KICAgICAgICAgICAgZm9yX2pzb25fYXJyYXkgIiR7c3VibmV0fSIgIi5leGNlcHQiIF9kcm9wX3N1Ym5ldAogICAgICAgIGZpCgogICAgICAgIGlmIFtbICIkKGdldF9vYmplY3QgIiR7c3VibmV0fSIgIi5jaWRyIikiID09ICJudWxsIiB8fCAiJChnZXRfb2JqZWN0ICIke3N1Ym5ldH0iICIuY2lkciIpIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSAiJHtDTklfSUZOQU1FfSItJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1zdWJuZXRzICR7bWF0Y2hfaWZhY2V9ICRDTklfSUZOQU1FIGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtYXJrIG9yIDB4MjAwMDApIHx8ICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZSB0byBhbGxvdyBhbGwgc3VibmV0cyBpbiBjaGFpbjogJHtDTklfSUZOQU1FfS0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXN1Ym5ldHMiCiAgICAgICAgZWxzZQogICAgICAgICAgICBfYWNjZXB0X2NpZHIgIiR7c3VibmV0fSIKICAgICAgICBmaQogICAgfQoKICAgIF9kcm9wX3N1Ym5ldCgpIHsKICAgICAgICBsb2NhbCBzdWJuZXQ9IiQxIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXN1Ym5ldHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJChnZXRfaXBfdmVyc2lvbiAiJHtzdWJuZXR9IikgJHttYXRjaF9hZGRyfSAke3N1Ym5ldH0gY291bnRlciBkcm9wKSB8fCAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gZHJvcCBzdWJuZXQgJHtzdWJuZXR9IGluIGNoYWluOiAke0NOSV9JRk5BTUV9LSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tc3VibmV0cyIKICAgIH0KCiAgICBfYWNjZXB0X2NpZHIoKSB7CiAgICAgICAgbG9jYWwgc3VibmV0PSIkMSIKICAgICAgICBsb2NhbCBjaWRyPSQoZWNobyAiJHtzdWJuZXR9IiB8IGpxIC1yICIuY2lkciIpCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHt0YWJsZV90eXBlfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tc3VibmV0cyAke21hdGNoX2lmYWNlfSAkQ05JX0lGTkFNRSAkKGdldF9pcF92ZXJzaW9uICIke2NpZHJ9IikgJHttYXRjaF9hZGRyfSAke2NpZHJ9IGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtYXJrIG9yIDB4MjAwMDApIHx8ICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBjaWRyICR7Y2lkcn0gaW4gY2hhaW46ICR7Q05JX0lGTkFNRX0tJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1zdWJuZXRzIgogICAgfQoKICAgIF9hY2NlcHRfcG9ydCgpIHsKICAgICAgICBsb2NhbCBwb3J0cz0iJDEiCiAgICAgICAgbG9jYWwgcG9ydD0kKGVjaG8gIiRwb3J0cyIgfCBqcSAtciAiLnBvcnQiKQogICAgICAgIGxvY2FsIHByb3RvY29sPSQoZWNobyAiJHBvcnRzIiB8IGpxIC1yICIucHJvdG9jb2wiKQoKICAgICAgICBpZiBbWyAiJHBvcnQiID09ICJudWxsIiB8fCAiJHBvcnQiID09ICIiIF1dOyB0aGVuCiAgICAgICAgICAgIGlmIFtbICIkcHJvdG9jb2wiID09ICJudWxsIiB8fCAiJHByb3RvY29sIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHt0YWJsZV90eXBlfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAifCIgMHgwMDAxMDAwMCkgfHwgIGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IGFsbCBwb3J0cyBvbiBhbGwgcHJvdG9jb2xzIGluIGNoYWluOiAke0NOSV9JRk5BTUV9LSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMiCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXBvcnRzICR7bWF0Y2hfaWZhY2V9ICRDTklfSUZOQU1FIGlwIHByb3RvY29sICR7cHJvdG9jb2wsLH0gY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAifCIgMHgwMDAxMDAwMCkgfHwgIGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IGFsbCBwb3J0cyBvbiBpcHY0ICR7cHJvdG9jb2x9IGluIGNoYWluOiAke0NOSV9JRk5BTUV9LSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMiCiAgICAgICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSAiJHtDTklfSUZOQU1FfSItJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1wb3J0cyAke21hdGNoX2lmYWNlfSAkQ05JX0lGTkFNRSBpcDYgbmV4dGhkciAke3Byb3RvY29sLCx9IGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtZXRhIG1hcmsgInwiIDB4MDAwMTAwMDApIHx8ICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhbGwgcG9ydHMgb24gaXB2NiAke3Byb3RvY29sfSBpbiBjaGFpbjogJHtDTklfSUZOQU1FfS0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXBvcnRzIgogICAgICAgICAgICBmaQogICAgICAgIGVsc2UKICAgICAgICAgICAgaWYgW1sgIiRwcm90b2NvbCIgPT0gIm51bGwiIHx8ICIkcHJvdG9jb2wiID09ICIiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSAiJHtDTklfSUZOQU1FfSItJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1wb3J0cyAke21hdGNoX2lmYWNlfSAkQ05JX0lGTkFNRSB0Y3AgZHBvcnQgJHtwb3J0fSBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWV0YSBtYXJrICJ8IiAweDAwMDEwMDAwKSB8fCAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWxsb3cgcG9ydChzKSAke3BvcnR9IG9uIHRjcCBpbiBjaGFpbjogJHtDTklfSUZOQU1FfS0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXBvcnRzIgogICAgICAgICAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHt0YWJsZV90eXBlfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgdWRwIGRwb3J0ICR7cG9ydH0gY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAifCIgMHgwMDAxMDAwMCkgfHwgIGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IHBvcnQocykgJHtwb3J0fSBvbiB1ZHAgaW4gY2hhaW46ICR7Q05JX0lGTkFNRX0tJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1wb3J0cyIKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHt0YWJsZV90eXBlfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJHtwcm90b2NvbCwsfSBkcG9ydCAke3BvcnR9IGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtZXRhIG1hcmsgInwiIDB4MDAwMTAwMDApIHx8ICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBwb3J0KHMpICR7cG9ydH0gb24gJHtwcm90b2NvbH0gaW4gY2hhaW46ICR7Q05JX0lGTkFNRX0tJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1wb3J0cyIKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgfQoKICAgIGxvY2FsIGlzX2ZpbHRlcmluZ19jaGFpbl9jcmVhdGVkPWZhbHNlCiAgICBpZiBbWyAkKGVjaG8gIiRjb25maWciIHwganEgLXIgIi4ke2RpcmVjdGlvbn0uc3VibmV0cyIpICE9ICJudWxsIiB8fCAkKGVjaG8gIiRjb25maWciIHwganEgLXIgIi4ke2RpcmVjdGlvbn0ucG9ydHMiKSAhPSAibnVsbCIgXV07IHRoZW4KICAgICAgICBfY3JlYXRlX2ZpbHRlcmluZ19jaGFpbiAiJHtjb25maWdfaWR9IiAiJHtjb25maWd9IiAiJHt0YWJsZV90eXBlfSIgIiR7ZGlyZWN0aW9ufSIKICAgICAgICBpc19maWx0ZXJpbmdfY2hhaW5fY3JlYXRlZD10cnVlCiAgICBmaQoKICAgICMgaGFuZGxlIGlwIHN1Ym5ldAogICAgaWYgW1sgJChlY2hvICIkY29uZmlnIiB8IGpxIC1yICIuJHtkaXJlY3Rpb259LnN1Ym5ldHMiKSAhPSAibnVsbCIgJiYgJChnZXRfYXJyYXlfbGVuICIkY29uZmlnIiAiLiR7ZGlyZWN0aW9ufS5zdWJuZXRzIikgPiAwIF1dOyB0aGVuCgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIgY291bnRlciBqdW1wICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cyIKCiAgICAgICAgZm9yX2pzb25fYXJyYXkgIiRjb25maWciICIuJHtkaXJlY3Rpb259LnN1Ym5ldHMiIF9jcmVhdGVfc3VibmV0X3J1bGUKICAgIGZpCgogICAgIyBoYW5kbGUgcG9ydHMKICAgIGlmIFtbICQoZWNobyAiJGNvbmZpZyIgfCBqcSAtciAiLiR7ZGlyZWN0aW9ufS5wb3J0cyIpICE9ICJudWxsIiAmJiAkKGdldF9hcnJheV9sZW4gIiRjb25maWciICIuJHtkaXJlY3Rpb259LnBvcnRzIikgPiAwIF1dOyB0aGVuCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1wb3J0cykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1wb3J0cyIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iIGNvdW50ZXIganVtcCAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItcG9ydHMpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1wb3J0cyIKICAgICAgICAKICAgICAgICBmb3JfanNvbl9hcnJheSAiJGNvbmZpZyIgIi4ke2RpcmVjdGlvbn0ucG9ydHMiIF9hY2NlcHRfcG9ydAogICAgZmkKCiAgICBpZiBbWyAiJGlzX2ZpbHRlcmluZ19jaGFpbl9jcmVhdGVkIiA9PSB0cnVlIF1dOyB0aGVuCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259IiBtZXRhIG1hcmsgIiYiIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIGFjY2VwdCkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IG1hcmsgJiAweDAwMDMwMDAwID09IDB4MDAwMzAwMDAgY291bnRlciBhY2NlcHQiCiAgICBmaQp9CgpleGl0V2l0aEVycm9yKCkgewogICAgbG9jYWwgY25pX3ZlcnNpb249IiQxIgogICAgbG9jYWwgbWVzc2FnZT0iJHsyOi0iIn0iCiAgICBsb2NhbCBkZXRhaWxzPSIkezM6LSIifSIKICAgIGVjaG8gIntcImNuaVZlcnNpb25cIjogXCIke2NuaV92ZXJzaW9ufVwiLFwibXNnXCI6XCIke21lc3NhZ2V9XCIsXCJjb2RlXCI6MTAxLFwiZGV0YWlsc1wiOlwiJHtkZXRhaWxzfVwifSIKICAgIGV4aXQgMQp9CgpleGl0V2l0aFN1Y2Nlc3MoKSB7CiAgICBsb2NhbCBjbmlfdmVyc2lvbj0iJDEiCiAgICBsb2NhbCBwcmV2X3Jlc3VsdD0iJDIiCiAgICBpZiBbWyAiJHByZXZfcmVzdWx0IiA9PSAibnVsbCIgXV07IHRoZW4KICAgICAgICBlY2hvICJ7XCJjbmlWZXJzaW9uXCI6IFwiJGNuaV92ZXJzaW9uXCJ9IgogICAgZWxzZQogICAgICAgIGVjaG8gIiRwcmV2X3Jlc3VsdCIKICAgIGZpCiAgICBleGl0IDAKfQoKbWFpbigpIHsKICAgIGNhc2UgJENOSV9DT01NQU5EIGluCiAgICBBREQpCiAgICAgICAgZWNobyAiQ05JX05FVE5TOiAkQ05JX05FVE5TIiA+PiAkbG9nRmlsZQogICAgICAgIGVjaG8gIkNOSV9DT05UQUlORVJJRDogJENOSV9DT05UQUlORVJJRCIgPj4gJGxvZ0ZpbGUKICAgICAgICBlY2hvICJTVERJTjogJHN0ZGluIiA+PiAkbG9nRmlsZQogICAgICAgIGVjaG8gIkNOSV9BUkdTOiAkQ05JX0FSR1MiID4+ICRsb2dGaWxlCgogICAgICAgIGxvY2FsIGNpZHJfZmlsdGVyaW5nX2NuaV9sYWJlbD0iYnJpZGdlLWZpbHRlcmluZyIKICAgICAgICBsb2NhbCBjbmlfc3BlY19uYW1lPSQoZWNobyAiJHN0ZGluIiB8IGpxIC1yICIubmFtZSIpCiAgICAgICAgbG9jYWwgcG9kX25hbWVzcGFjZT0iIgoKICAgICAgICBmb3IgaSBpbiAke0NOSV9BUkdTLy87LyB9CiAgICAgICAgZG8KICAgICAgICAgICAgY2FzZSAkaSBpbgogICAgICAgICAgICAiSzhTX1BPRF9OQU1FU1BBQ0U9IiopCiAgICAgICAgICAgICAgICBwb2RfbmFtZXNwYWNlPSQoZWNobyAkaSB8IGF3ayAtRic9JyAne3ByaW50ICQyfScpCiAgICAgICAgICAgICAgICBpZiBbWyAiJHBvZF9uYW1lc3BhY2UiID09ICIiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gcGFyc2UgcG9kIG5hbWVzcGFjZSBmcm9tIENOSV9BUkdTIgogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgOzsKICAgICAgICAgICAgZXNhYwogICAgICAgIGRvbmUKCiAgICAgICAgbWtkaXIgLXAgL3Zhci9ydW4vbmV0bnMvCiAgICAgICAgbG4gLXNmVCAiJENOSV9ORVROUyIgL3Zhci9ydW4vbmV0bnMvIiR7Q05JX0NPTlRBSU5FUklEfSIKCiAgICAgICAgIyBDaGVjayBBUEkgYWNjZXNzCiAgICAgICAga3ViZWN0bCAtLWt1YmVjb25maWc9JHtLVUJFQ09ORklHX1BBVEh9IGFwaS1yZXNvdXJjZXMgPiAvZGV2L251bGwgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gcmVhY2gga3ViZXJuZXRlcyBBUEkgc2VydmVyIiAia3ViZWNvbmZpZyBwYXRoOiAkS1VCRUNPTkZJR19QQVRIIgoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV90YWJsZSAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gY3JlYXRlIHRhYmxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgdGFibGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0iCgogICAgICAgICMgY3JlYXRlIGJhc2UgY2hhaW5zCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfYmFzZV9jaGFpbiAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSAke05GVF9JTkdSRVNTX0NIQUlOfSAke05GVF9JTkdSRVNTX0hPT0t9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgYmFzZSBjaGFpbiAke05GVF9JTkdSRVNTX0NIQUlOfSIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9iYXNlX2NoYWluICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICR7TkZUX1BPU1RST1VUSU5HX0NIQUlOfSAke05GVF9FR1JFU1NfSE9PS30pIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGNyZWF0ZSBicmlkZ2UgYmFzZSBjaGFpbiAke05GVF9QT1NUUk9VVElOR19DSEFJTn0iCgogICAgICAgICMgZmlsdGVyIGNoYWlucwogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii1pbmdyZXNzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgY2hhaW4gIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLWVncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii1lZ3Jlc3MiCgogICAgICAgICMgc2V0dXAgcHJlcm91dGluZyBjaGFpbgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICR7TkZUX0lOR1JFU1NfQ0hBSU59IGV0aGVyIHR5cGUgYXJwIGNvdW50ZXIgYWNjZXB0KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhcnAgZm9yIGluZ3Jlc3MiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gJHtORlRfSU5HUkVTU19DSEFJTn0gaWlmbmFtZSAkQ05JX0lGTkFNRSBjb3VudGVyIGp1bXAgIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wICIke0NOSV9JRk5BTUV9Ii1pbmdyZXNzIgoKICAgICAgICAjIHNldHVwIHBvc3Ryb3V0aW5nIGNoYWluCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gJHtORlRfUE9TVFJPVVRJTkdfQ0hBSU59IGV0aGVyIHR5cGUgYXJwIGNvdW50ZXIgYWNjZXB0KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhcnAgZm9yIGVncmVzcyIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gb2lmbmFtZSAkQ05JX0lGTkFNRSBjb3VudGVyIGp1bXAgIiR7Q05JX0lGTkFNRX0iLWVncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGp1bXAgIiR7Q05JX0lGTkFNRX0iLWVncmVzcyIKCiAgICAgICAgX3Byb2Nlc3NfY29uZmlnbWFwKCkgewogICAgICAgICAgICBsb2NhbCBjb25maWdtYXBfbmFtZT0iJDEiCiAgICAgICAgICAgIGxvY2FsIGNvbmZpZ21hcF9uYW1lc3BhY2U9IiQyIgogICAgICAgICAgICBsb2NhbCBjb25maWdfaWQ9IiQoZWNobyAiJHtjb25maWdtYXBfbmFtZX0ke2NvbmZpZ21hcF9uYW1lc3BhY2V9IiB8IHNoYTFzdW0gKSIKICAgICAgICAgICAgY29uZmlnX2lkPSIke2NvbmZpZ19pZDowOjV9IiAjIHVzZSBmaXJzdCA1IGNoYXJhY3RlcnMgdG8gaWRlbnRpZnkgY29uZmlndXJhdGlvbiBzcGVjaWZpZWQgaW4gYSBjb25maWdtYXAKCiAgICAgICAgICAgICMgdGhlIGpzb24gY29uZmlnIGluIGNvbmZpZ21hcCBpcyBlc2NhcGVkIHdoZW4gdGhlIGNvbmZpZ21hcCBpdHNlbGYgaXMgb2J0YWluZWQgaW4ganNvbi4gVG8gYmUgYWJsZSB0byB3b3JrIHdpdGggaXQgd2l0aCBqcSwgd2UgbmVlZCB0byByZW1vdmUgJ1xuJywgJ1wnJywgc3BhY2VzIGFuZCBsZWFkaW5nL3RyYWlsaW5nIGNoYXJhY3RlciAod2hpY2ggaXMgYW4gYXBvc3Ryb3BoZSkKICAgICAgICAgICAgbG9jYWwgY29uZmlnPSQoa3ViZWN0bCAtLWt1YmVjb25maWc9JHtLVUJFQ09ORklHX1BBVEh9IGdldCBjbSAke2NvbmZpZ21hcF9uYW1lfSAtbiAke2NvbmZpZ21hcF9uYW1lc3BhY2V9IC1vIGpzb24gfCBqcSAtYyAnLmRhdGEuImNvbmZpZy5qc29uIicgfCBzZWQgJ3MjXFxuIyNnO3MjXFwjI2c7cyMgIyNnO3MvXi4vLztzLy4kLy8nKQoKICAgICAgICAgICAgY3JlYXRlX3J1bGVzX2Zvcl9maWx0ZXJpbmcgIiRjb25maWdfaWQiICIkY29uZmlnIiAiJHtORlRfQlJJREdFX1RBQkxFfSIgImluZ3Jlc3MiCiAgICAgICAgICAgIGNyZWF0ZV9ydWxlc19mb3JfZmlsdGVyaW5nICIkY29uZmlnX2lkIiAiJGNvbmZpZyIgIiR7TkZUX0JSSURHRV9UQUJMRX0iICJlZ3Jlc3MiCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBjb25maWdtYXBfbmFtZSBpbiAkKGt1YmVjdGwgLS1rdWJlY29uZmlnPSR7S1VCRUNPTkZJR19QQVRIfSBnZXQgY20gLWwke2NuaV9zcGVjX25hbWV9LCR7Y2lkcl9maWx0ZXJpbmdfY25pX2xhYmVsfSAtbiAke3BvZF9uYW1lc3BhY2V9IC1vIGpzb25wYXRoPSd7cmFuZ2UgLml0ZW1zWypdfXtALm1ldGFkYXRhLm5hbWV9eyJcbiJ9JyB8IGhlYWQgLW4gLTEpOyBkbwogICAgICAgICAgICBfcHJvY2Vzc19jb25maWdtYXAgJGNvbmZpZ21hcF9uYW1lICRwb2RfbmFtZXNwYWNlCiAgICAgICAgZG9uZQoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHtORlRfQlJJREdFX1RBQkxFfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MgY291bnRlciBkcm9wKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZTogZHJvcCIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHtORlRfQlJJREdFX1RBQkxFfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLWVncmVzcyBjb3VudGVyIGRyb3ApIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBkcm9wIgoKICAgICAgICBleGl0V2l0aFN1Y2Nlc3MgIiR7Q05JX1ZFUlNJT059IiAiJHtDTklfUFJFVl9SRVNVTFR9IgogICAgOzsKCiAgICBERUwpCiAgICAgICAgZWNobyAiRGVsZXRlICRDTklfQ09OVEFJTkVSSUQiID4+ICRsb2dGaWxlCiAgICAgICAgcm0gLWYgL3Zhci9ydW4vbmV0bnMvIiRDTklfQ09OVEFJTkVSSUQiCiAgICA7OwoKICAgIFZFUlNJT04pCiAgICAgICAgZWNobyAie1wiY25pVmVyc2lvblwiOlwiMC4zLjFcIixcInN1cHBvcnRlZFZlcnNpb25zXCI6W1wiMC4xLjBcIixcIjAuMi4wXCIsXCIwLjMuMFwiLFwiMC4zLjFcIl19IgogICAgOzsKCiAgICAqKQogICAgICAgIGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiVW5yZWNvZ25pemVkIENOSSBjb21tYW5kOiAke0NOSV9DT01NQU5EfSIKICAgIDs7CgogICAgZXNhYwp9CgptYWluCg=="
        securityContext:
          privileged: true
        volumeMounts:
        - name: cni
          mountPath: /host/etc/cni/net.d
        - name: cnibin
          mountPath: /host/opt/cni/bin
        command:
          - /bin/bash
          - -c
          - |
            echo $(SCRIPT) | base64 -d > /host/opt/cni/bin/$(CNI_NAME) &&\
            chmod +x /host/opt/cni/bin/$(CNI_NAME)

            # Inspired by: https://tinyurl.com/y7r2knme
            CIDR_TEMP_KUBECONFIG="/tmp/bridge-filtering.kubeconfig"
            CIDR_KUBECONFIG_FILE_HOST=$(CNI_CONF_DIR)/bridge-filtering.d/bridge-filtering.kubeconfig
            mkdir -p $(CNI_CONF_DIR)/bridge-filtering.d
            
            DEFAULT_KUBECONFIG_PATH="/etc/cni/net.d/bridge-filtering.d/bridge-filtering.kubeconfig"
            sed -i "s#${DEFAULT_KUBECONFIG_PATH}#$(KUBECONFIG_PATH)#" /host/opt/cni/bin/$(CNI_NAME)

            SERVICE_ACCOUNT_PATH=/var/run/secrets/kubernetes.io/serviceaccount
            KUBE_CA_FILE=${KUBE_CA_FILE:-$SERVICE_ACCOUNT_PATH/ca.crt}
            SERVICEACCOUNT_TOKEN=$(cat $SERVICE_ACCOUNT_PATH/token)
            SKIP_TLS_VERIFY=${SKIP_TLS_VERIFY:-false}

            # Check if we're running as a k8s pod.
            if [ -f "$SERVICE_ACCOUNT_PATH/token" ]; then
              # We're running as a k8d pod - expect some variables.
              if [ -z ${KUBERNETES_SERVICE_HOST} ]; then
                error "KUBERNETES_SERVICE_HOST not set"; exit 1;
              fi
              if [ -z ${KUBERNETES_SERVICE_PORT} ]; then
                error "KUBERNETES_SERVICE_PORT not set"; exit 1;
              fi

              if [ "$SKIP_TLS_VERIFY" == "true" ]; then
                TLS_CFG="insecure-skip-tls-verify: true"
              elif [ -f "$KUBE_CA_FILE" ]; then
                TLS_CFG="certificate-authority-data: $(cat $KUBE_CA_FILE | base64 | tr -d '\n')"
              fi

              # Write a kubeconfig file for the CNI plugin.  Do this
              # to skip TLS verification for now.  We should eventually support
              # writing more complete kubeconfig files. This is only used
              # if the provided CNI network config references it.
              touch $CIDR_TEMP_KUBECONFIG
              chmod ${KUBECONFIG_MODE:-600} $CIDR_TEMP_KUBECONFIG
              # Write the kubeconfig to a temp file first.
              cat > $CIDR_TEMP_KUBECONFIG <<EOF
            # Kubeconfig file for CIDR CNI plugin.
            apiVersion: v1
            kind: Config
            clusters:
            - name: local
              cluster:
                server: ${KUBERNETES_SERVICE_PROTOCOL:-https}://[${KUBERNETES_SERVICE_HOST}]:${KUBERNETES_SERVICE_PORT}
                $TLS_CFG
            users:
            - name: bridge-filtering
              user:
                token: "${SERVICEACCOUNT_TOKEN}"
            contexts:
            - name: bridge-filtering-context
              context:
                cluster: local
                user: bridge-filtering
            current-context: bridge-filtering-context
            EOF

              # Atomically move the temp kubeconfig to its permanent home.
              mv -f $CIDR_TEMP_KUBECONFIG $CIDR_KUBECONFIG_FILE_HOST
            else
              warn "Doesn't look like we're running in a kubernetes environment (no serviceaccount token)"
            fi
      containers:
      - name: bridge-filtering
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        command: ["sleep"]
        args: ["infinity"]
        resources:
          requests:
            cpu: "10m"
            memory: "25Mi"
          limits:
            cpu: "10m"
            memory: "25Mi"
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: cnibin
        hostPath:
          path: /opt/cni/bin
