---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cidr-filtering
subjects:
- kind: ServiceAccount
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cidr-filtering-cni-ds
  namespace: kube-system
  labels:
    tier: node
    app: cidr-filtering-cni
    name: cidr-filtering-cni
spec:
  selector:
    matchLabels:
      name: cidr-filtering-cni
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        tier: node
        app: cidr-filtering-cni
        name: cidr-filtering-cni
    spec:
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      serviceAccountName: cidr-filtering
      initContainers:
      - name: cidr-filtering-cni-copier
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        env:
        - name: CNI_NAME
          value: cidr-filtering-cni
        - name: CNI_CONF_DIR
          value: "/host/etc/cni/net.d"
        - name: SCRIPT
          value: "IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpzdGRpbj0kKGNhdCAvZGV2L3N0ZGluKQpsb2dGaWxlPSIke0xPR0ZJTEU6LS92YXIvbG9nL2NpZHItZmlsdGVyaW5nLWNuaS5sb2d9IgoKQ05JX1ZFUlNJT049IiQoZWNobyAiJHN0ZGluIiB8IGpxIC1yICIuY25pVmVyc2lvbiIpIgpDTklfUFJFVl9SRVNVTFQ9IiQoZWNobyAiJHN0ZGluIiB8IGpxIC1jciAiLnByZXZSZXN1bHQiKSIKCmV4ZWMgMj4+ICRsb2dGaWxlCgpORlRfSU5HUkVTU19UQUJMRV9UWVBFPWJyaWRnZQpORlRfRUdSRVNTX1RBQkxFX1RZUEU9YnJpZGdlCk5GVF9UQUJMRT1maWx0ZXIKCk5GVF9JTkdSRVNTX0NIQUlOPXByZXJvdXRpbmcKTkZUX0lOR1JFU1NfSE9PSz1wcmVyb3V0aW5nCgpORlRfUE9TVFJPVVRJTkdfQ0hBSU49cG9zdHJvdXRpbmcKTkZUX0VHUkVTU19IT09LPXBvc3Ryb3V0aW5nCgpnZXRfb2JqZWN0KCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtY3IgIiRqc29uX3BhdGgiCn0KCmdldF9hcnJheV9pdGVtcygpIHsKICAgIGxvY2FsIGpzb25fb2JqZWN0PSIkMSIKICAgIGxvY2FsIGpzb25fcGF0aD0iJDIiCiAgICBlY2hvICIkanNvbl9vYmplY3QiIHwganEgLWMgJGpzb25fcGF0aCB8IGpxIC1jciAiLltdIgp9CgpnZXRfYXJyYXlfbGVuKCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtYyAiJGpzb25fcGF0aCIgfCBqcSAiLiB8IGxlbmd0aCIKfQoKZm9yX2pzb25fYXJyYXkoKSB7CiAgICBsb2NhbCBqc29uX29iamVjdD0iJDEiCiAgICBsb2NhbCBqc29uX3BhdGg9IiQyIgogICAgbG9jYWwgZm49IiQzIgogICAgZm9yIGl0ZW0gaW4gJChnZXRfYXJyYXlfaXRlbXMgIiRqc29uX29iamVjdCIgIiRqc29uX3BhdGgiKTsgZG8KICAgICAgICAkZm4gJGl0ZW0KICAgIGRvbmUKfQoKZ2V0X2lwX3ZlcnNpb24oKSB7CiAgICBsb2NhbCBpcF9hZGRyZXNzPSIkMSIKICAgIGlmIFtbICIkaXBfYWRkcmVzcyIgPX4gLio6LiogXV0KICAgIHRoZW4KICAgICAgICBlY2hvICJpcDYiCiAgICBlbHNlCiAgICAgICAgZWNobyAiaXAiCiAgICBmaQp9CgpjcmVhdGVfdGFibGUoKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgZWNobyAibmZ0IGFkZCB0YWJsZSAkdHlwZSAkbmFtZSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX25ldGRldl9iYXNlX2NoYWluKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGxvY2FsIGNoYWluPSIkMyIKICAgIGxvY2FsIGhvb2s9IiQ0IgogICAgbG9jYWwgZGV2aWNlPSIkNSIKICAgIGVjaG8gIm5mdCBhZGQgY2hhaW4gJHR5cGUgJG5hbWUgJGNoYWluIHsgdHlwZSBmaWx0ZXIgaG9vayAkaG9vayBkZXZpY2UgJGRldmljZSBwcmlvcml0eSAtMTsgcG9saWN5IGFjY2VwdDsgfSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX2Jhc2VfY2hhaW4oKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgbG9jYWwgY2hhaW49IiQzIgogICAgbG9jYWwgaG9vaz0iJDQiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiB7IHR5cGUgZmlsdGVyIGhvb2sgJGhvb2sgcHJpb3JpdHkgLTE7IHBvbGljeSBhY2NlcHQ7IH0iIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9jaGFpbigpIHsKICAgIGxvY2FsIHR5cGU9IiQxIgogICAgbG9jYWwgbmFtZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKbmZ0X2FkZF9ydWxlKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCB0YWJsZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBzZXQgLS0gIiR7QDo0fSIKICAgIGVjaG8gIm5mdCBhZGQgcnVsZSAkdHlwZSAkdGFibGUgJGNoYWluICRAIiB8IHRlZSAtYSAkbG9nRmlsZQp9CgpjcmVhdGVfcnVsZXNfZm9yX2ZpbHRlcmluZygpIHsKICAgIGxvY2FsIGNvbmZpZ19pZD0iJDEiCiAgICBsb2NhbCBjb25maWc9IiQyIgogICAgbG9jYWwgdGFibGVfdHlwZT0iJDMiCiAgICBsb2NhbCBkaXJlY3Rpb249IiQ0IgoKICAgIGxvY2FsIG1hdGNoX2FkZHI9InNhZGRyIgogICAgaWYgW1sgIiRkaXJlY3Rpb24iID09ICJlZ3Jlc3MiIF1dOyB0aGVuCiAgICAgICAgbG9jYWwgbWF0Y2hfYWRkcj0iZGFkZHIiCiAgICBmaQogICAgbG9jYWwgbWF0Y2hfaWZhY2U9ImlpZm5hbWUiCiAgICBpZiBbWyAiJGRpcmVjdGlvbiIgPT0gImVncmVzcyIgXV07IHRoZW4KICAgICAgICBtYXRjaF9pZmFjZT0ib2lmbmFtZSIKICAgIGZpCgogICAgX2NyZWF0ZV9maWx0ZXJpbmdfY2hhaW4oKSB7CiAgICAgICAgbG9jYWwgY29uZmlnX2lkPSIkMSIKICAgICAgICBsb2NhbCBjb25maWc9IiQyIgogICAgICAgIGxvY2FsIHRhYmxlX3R5cGU9IiQzIgogICAgICAgIGxvY2FsIGRpcmVjdGlvbj0iJDQiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iIG0tIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBjaGFpbiBtLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0iCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iIG0tIiR7ZGlyZWN0aW9ufSIgIiR7bWF0Y2hfaWZhY2V9IiAiJENOSV9JRk5BTUUiIGNvdW50ZXIganVtcCBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0iCiAgICB9CgogICAgX2NyZWF0ZV9zdWJuZXRfcnVsZSgpIHsKICAgICAgICBsb2NhbCBzdWJuZXQ9JDEKICAgICAgICBpZiBbWyAiJChnZXRfb2JqZWN0ICIke3N1Ym5ldH0iICIuc3VibmV0LmV4Y2VwdCIpIiAhPSAibnVsbCIgXV07IHRoZW4KICAgICAgICAgICAgZm9yX2pzb25fYXJyYXkgIiR7c3VibmV0fSIgIi5zdWJuZXQuZXhjZXB0IiBfZHJvcF9pcAogICAgICAgIGZpCgogICAgICAgIGlmIFtbICIkKGdldF9vYmplY3QgIiR7c3VibmV0fSIgIi5zdWJuZXQuY2lkciIpIiA9PSAibnVsbCIgXV07IHRoZW4KICAgICAgICAgICAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJjaWRyIG11c3QgYmUgc3BlY2lmaWVkLiIKICAgICAgICBmaQogICAgICAgIF9hY2NlcHRfY2lkciAiJHtzdWJuZXR9IgogICAgfQoKICAgIF9kcm9wX2lwKCkgewogICAgICAgIGxvY2FsIGlwPSIkMSIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSBtLSR7Y29uZmlnX2lkfS0ke2RpcmVjdGlvbn0tc3VibmV0cyAke21hdGNoX2lmYWNlfSAkQ05JX0lGTkFNRSAkKGdldF9pcF92ZXJzaW9uICIke2lwfSIpICR7bWF0Y2hfYWRkcn0gJHtpcH0gY291bnRlciBkcm9wKQogICAgfQoKICAgIF9hY2NlcHRfY2lkcigpIHsKICAgICAgICBsb2NhbCBzdWJuZXQ9IiQxIgogICAgICAgIGxvY2FsIGNpZHI9JChlY2hvICIke3N1Ym5ldH0iIHwganEgLXIgIi5zdWJuZXQuY2lkciIpCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHt0YWJsZV90eXBlfSAke05GVF9UQUJMRX0gbS0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXN1Ym5ldHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJChnZXRfaXBfdmVyc2lvbiAiJHtjaWRyfSIpICR7bWF0Y2hfYWRkcn0gJHtjaWRyfSBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWFyayBvciAweDIwMDAwKQogICAgfQoKICAgIF9hY2NlcHRfcG9ydCgpIHsKICAgICAgICBsb2NhbCBwb3J0cz0iJDEiCiAgICAgICAgbG9jYWwgcG9ydD0kKGVjaG8gIiRwb3J0cyIgfCBqcSAtciAiLnBvcnQiKQogICAgICAgIGxvY2FsIHByb3RvY29sPSQoZWNobyAiJHBvcnRzIiB8IGpxIC1yICIucHJvdG9jb2wiKQoKICAgICAgICBpZiBbWyAiJHBvcnQiID09ICJudWxsIiB8fCAiJHByb3RvY29sIiA9PSAibnVsbCIgfHwgIiRwb3J0IiA9PSAiIiB8fCAiJHByb3RvY29sIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIlBvcnQgYW5kIHByb3RvY29sIG11c3QgYmUgc3BlY2lmaWVkLiIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9IG0tJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufS1wb3J0cyAke21hdGNoX2lmYWNlfSAkQ05JX0lGTkFNRSAke3Byb3RvY29sLCx9IGRwb3J0ICR7cG9ydH0gY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAifCIgMHgwMDAxMDAwMCkKICAgICAgICBmaQogICAgfQoKICAgIGxvY2FsIGlzX2ZpbHRlcmluZ19jaGFpbl9jcmVhdGVkPWZhbHNlCiAgICAjIGhhbmRsZSBpcCBzdWJuZXQKICAgIGlmIFtbICQoZWNobyAiJGNvbmZpZyIgfCBqcSAtciAiLiR7ZGlyZWN0aW9ufS5zdWJuZXRzIikgIT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgX2NyZWF0ZV9maWx0ZXJpbmdfY2hhaW4gIiR7Y29uZmlnX2lkfSIgIiR7Y29uZmlnfSIgIiR7dGFibGVfdHlwZX0iICIke2RpcmVjdGlvbn0iCiAgICAgICAgaXNfZmlsdGVyaW5nX2NoYWluX2NyZWF0ZWQ9dHJ1ZQoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9jaGFpbiAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgbS0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgY2hhaW4gbS0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iIGNvdW50ZXIganVtcCBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXN1Ym5ldHMpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wIG0tIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cyIKCiAgICAgICAgaWYgW1sgJChnZXRfYXJyYXlfbGVuICIkY29uZmlnIiAiLiR7ZGlyZWN0aW9ufS5zdWJuZXRzIikgPT0gMCBdXTsgdGhlbgogICAgICAgICAgICAjIGV4YW1wbGU6ICBpbmdyZXNzOiB7c3VibmV0czogW119ICA9PiB0cmFuc2xhdGVzIHRvIGFsbG93IGFsbCBzdWJuZXRzCiAgICAgICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9IG0tIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cyBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWFyayBvciAweDIwMDAwKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhbGwgTDMgdHJhZmZpYyIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGZvcl9qc29uX2FycmF5ICIkY29uZmlnIiAiLiR7ZGlyZWN0aW9ufS5zdWJuZXRzIiBfY3JlYXRlX3N1Ym5ldF9ydWxlCiAgICAgICAgZmkKICAgIGZpCgogICAgIyBoYW5kbGUgcG9ydHMKICAgIGlmIFtbICQoZWNobyAiJGNvbmZpZyIgfCBqcSAtciAiLiR7ZGlyZWN0aW9ufS5wb3J0cyIpICE9ICJudWxsIiBdXTsgdGhlbgogICAgICAgIGlmIFtbICIkaXNfZmlsdGVyaW5nX2NoYWluX2NyZWF0ZWQiID09IGZhbHNlIF1dOyB0aGVuCiAgICAgICAgICAgIF9jcmVhdGVfZmlsdGVyaW5nX2NoYWluICIke2NvbmZpZ19pZH0iICIke2NvbmZpZ30iICIke3RhYmxlX3R5cGV9IiAiJHtkaXJlY3Rpb259IgogICAgICAgICAgICBpc19maWx0ZXJpbmdfY2hhaW5fY3JlYXRlZD10cnVlCiAgICAgICAgZmkKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gIiR7dGFibGVfdHlwZX0iICIke05GVF9UQUJMRX0iIG0tIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItcG9ydHMpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBjaGFpbiBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iIGNvdW50ZXIganVtcCBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzIgogICAgICAgIAogICAgICAgIGlmIFtbICQoZ2V0X2FycmF5X2xlbiAiJGNvbmZpZyIgIi4ke2RpcmVjdGlvbn0ucG9ydHMiKSA9PSAwIF1dOyB0aGVuCiAgICAgICAgICAgICMgZXhhbXBsZTogICJlZ3Jlc3MiOiB7InBvcnRzIjogW119ICA9PiB0cmFuc2xhdGVzIHRvIGFsbG93IGFsbCBwb3J0cwogICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSBtLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzIGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtZXRhIG1hcmsgInwiIDB4MDAwMTAwMDApIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IGFsbCBMNCB0cmFmZmljIHdoZW4gbm90IGV4cGxpY2l0IGNvbmZpZyBwcm92aWRlZCIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGZvcl9qc29uX2FycmF5ICIkY29uZmlnIiAiLiR7ZGlyZWN0aW9ufS5wb3J0cyIgX2FjY2VwdF9wb3J0CiAgICAgICAgZmkKICAgIGZpCn0KCmV4aXRXaXRoRXJyb3IoKSB7CiAgICBsb2NhbCBjbmlfdmVyc2lvbj0iJDEiCiAgICBsb2NhbCBtZXNzYWdlPSIkezI6LSIifSIKICAgIGxvY2FsIGRldGFpbHM9IiR7MzotIiJ9IgogICAgZWNobyAie1wiY25pVmVyc2lvblwiOiBcIiR7Y25pX3ZlcnNpb259XCIsXCJtc2dcIjpcIiR7bWVzc2FnZX1cIixcImNvZGVcIjoxMDEsXCJkZXRhaWxzXCI6XCIke2RldGFpbHN9XCJ9IgogICAgZXhpdCAxCn0KCmV4aXRXaXRoU3VjY2VzcygpIHsKICAgIGxvY2FsIGNuaV92ZXJzaW9uPSIkMSIKICAgIGxvY2FsIHByZXZfcmVzdWx0PSIkMiIKICAgIGlmIFtbICIkcHJldl9yZXN1bHQiID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIntcImNuaVZlcnNpb25cIjogXCIkY25pX3ZlcnNpb25cIn0iCiAgICBlbHNlCiAgICAgICAgZWNobyAiJHByZXZfcmVzdWx0IgogICAgZmkKICAgIGV4aXQgMAp9CgptYWluKCkgewogICAgY2FzZSAkQ05JX0NPTU1BTkQgaW4KICAgIEFERCkKICAgICAgICBlY2hvICJDTklfTkVUTlM6ICRDTklfTkVUTlMiID4+ICRsb2dGaWxlCiAgICAgICAgZWNobyAiQ05JX0NPTlRBSU5FUklEOiAkQ05JX0NPTlRBSU5FUklEIiA+PiAkbG9nRmlsZQogICAgICAgIGVjaG8gIlNURElOOiAkc3RkaW4iID4+ICRsb2dGaWxlCiAgICAgICAgZWNobyAiQ05JX0FSR1M6ICRDTklfQVJHUyIgPj4gJGxvZ0ZpbGUKCiAgICAgICAgbG9jYWwgY2lkcl9maWx0ZXJpbmdfY25pX2xhYmVsPSJjaWRyLWZpbHRlcmluZy1jbmkiCiAgICAgICAgbG9jYWwgY25pX3NwZWNfbmFtZT0kKGVjaG8gIiRzdGRpbiIgfCBqcSAtciAiLm5hbWUiKQogICAgICAgIGxvY2FsIHBvZF9uYW1lc3BhY2U9IiIKCiAgICAgICAgZm9yIGkgaW4gJHtDTklfQVJHUy8vOy8gfQogICAgICAgIGRvCiAgICAgICAgICAgIGNhc2UgJGkgaW4KICAgICAgICAgICAgIks4U19QT0RfTkFNRVNQQUNFPSIqKQogICAgICAgICAgICAgICAgcG9kX25hbWVzcGFjZT0kKGVjaG8gJGkgfCBhd2sgLUYnPScgJ3twcmludCAkMn0nKQogICAgICAgICAgICAgICAgaWYgW1sgIiRwb2RfbmFtZXNwYWNlIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgICAgIGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIHBhcnNlIHBvZCBuYW1lc3BhY2UgZnJvbSBDTklfQVJHUyIKICAgICAgICAgICAgICAgIGZpCiAgICAgICAgICAgIDs7CiAgICAgICAgICAgIGVzYWMKICAgICAgICBkb25lCgogICAgICAgIG1rZGlyIC1wIC92YXIvcnVuL25ldG5zLwogICAgICAgIGxuIC1zZlQgIiRDTklfTkVUTlMiIC92YXIvcnVuL25ldG5zLyIke0NOSV9DT05UQUlORVJJRH0iCgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX0VHUkVTU19UQUJMRV9UWVBFfSAke05GVF9UQUJMRX0pIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGNyZWF0ZSB0YWJsZSAke05GVF9FR1JFU1NfVEFCTEVfVFlQRX0gJHtORlRfVEFCTEV9IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX0lOR1JFU1NfVEFCTEVfVFlQRX0gJHtORlRfVEFCTEV9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgdGFibGUgJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSIKCiAgICAgICAgIyBjcmVhdGUgYmFzZSBjaGFpbnMKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9iYXNlX2NoYWluICR7TkZUX0lOR1JFU1NfVEFCTEVfVFlQRX0gJHtORlRfVEFCTEV9ICR7TkZUX0lOR1JFU1NfQ0hBSU59ICR7TkZUX0lOR1JFU1NfSE9PS30pIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGNyZWF0ZSBiYXNlIGNoYWluICR7TkZUX0lOR1JFU1NfQ0hBSU59IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2Jhc2VfY2hhaW4gJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gJHtORlRfRUdSRVNTX0hPT0t9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgYnJpZGdlIGJhc2UgY2hhaW4gJHtORlRfUE9TVFJPVVRJTkdfQ0hBSU59IgoKICAgICAgICAjIGZpbHRlciBjaGFpbnMKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9jaGFpbiAke05GVF9JTkdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSBtLWluZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBjaGFpbiBtLWluZ3Jlc3MiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSBtLWVncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluIG0tZWdyZXNzIgoKICAgICAgICAjIHNldHVwIHByZXJvdXRpbmcgY2hhaW4KICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9JTkdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSAke05GVF9JTkdSRVNTX0NIQUlOfSBldGhlciB0eXBlIGFycCBjb3VudGVyIGFjY2VwdCkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWxsb3cgYXJwIGZvciBpbmdyZXNzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7TkZUX0lOR1JFU1NfVEFCTEVfVFlQRX0gJHtORlRfVEFCTEV9ICR7TkZUX0lOR1JFU1NfQ0hBSU59IGlpZm5hbWUgJENOSV9JRk5BTUUgY291bnRlciBqdW1wIG0taW5ncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGp1bXAgbS1pbmdyZXNzIgoKICAgICAgICAjIHNldHVwIHBvc3Ryb3V0aW5nIGNoYWluCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gZXRoZXIgdHlwZSBhcnAgY291bnRlciBhY2NlcHQpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IGFycCBmb3IgZWdyZXNzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7TkZUX0VHUkVTU19UQUJMRV9UWVBFfSAke05GVF9UQUJMRX0gJHtORlRfUE9TVFJPVVRJTkdfQ0hBSU59IG9pZm5hbWUgJENOSV9JRk5BTUUgY291bnRlciBqdW1wIG0tZWdyZXNzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLWVncmVzcyIKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0VHUkVTU19UQUJMRV9UWVBFfSIgIiR7TkZUX1RBQkxFfSIgbS1lZ3Jlc3MgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAiJiIgMHhmZmZjZmZmZikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9JTkdSRVNTX1RBQkxFX1RZUEV9IiAiJHtORlRfVEFCTEV9IiBtLWluZ3Jlc3MgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAiJiIgMHhmZmZjZmZmZikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgoKICAgICAgICBfcHJvY2Vzc19jb25maWdtYXAoKSB7CiAgICAgICAgICAgIGxvY2FsIGNvbmZpZ21hcF9uYW1lPSIkMSIKICAgICAgICAgICAgbG9jYWwgY29uZmlnbWFwX25hbWVzcGFjZT0iJDIiCiAgICAgICAgICAgIGxvY2FsIGNvbmZpZ19pZD0iJChlY2hvICIke2NvbmZpZ21hcF9uYW1lfSR7Y29uZmlnbWFwX25hbWVzcGFjZX0iIHwgc2hhMXN1bSApIgogICAgICAgICAgICBjb25maWdfaWQ9IiR7Y29uZmlnX2lkOjA6NX0iICMgdXNlIGZpcnN0IDUgY2hhcmFjdGVycyB0byBpZGVudGlmeSBjb25maWd1cmF0aW9uIHNwZWNpZmllZCBpbiBhIGNvbmZpZ21hcAoKICAgICAgICAgICAgIyB0aGUganNvbiBjb25maWcgaW4gY29uZmlnbWFwIGlzIGVzY2FwZWQgd2hlbiB0aGUgY29uZmlnbWFwIGl0c2VsZiBpcyBvYnRhaW5lZCBpbiBqc29uLiBUbyBiZSBhYmxlIHRvIHdvcmsgd2l0aCBpdCB3aXRoIGpxLCB3ZSBuZWVkIHRvIHJlbW92ZSAnXG4nLCAnXCcnLCBzcGFjZXMgYW5kIGxlYWRpbmcvdHJhaWxpbmcgY2hhcmFjdGVyICh3aGljaCBpcyBhbiBhcG9zdHJvcGhlKQogICAgICAgICAgICBsb2NhbCBjb25maWc9JChrdWJlY3RsIC0ta3ViZWNvbmZpZz0vZXRjL2NuaS9uZXQuZC9jaWRyLWZpbHRlcmluZy5kL2NpZHItZmlsdGVyaW5nLmt1YmVjb25maWcgZ2V0IGNtICR7Y29uZmlnbWFwX25hbWV9IC1uICR7Y29uZmlnbWFwX25hbWVzcGFjZX0gLW8ganNvbiB8IGpxIC1jICcuZGF0YS4iY29uZmlnLmpzb24iJyB8IHNlZCAncyNcXG4jI2c7cyNcXCMjZztzIyAjI2c7cy9eLi8vO3MvLiQvLycpCgogICAgICAgICAgICBjcmVhdGVfcnVsZXNfZm9yX2ZpbHRlcmluZyAiJGNvbmZpZ19pZCIgIiRjb25maWciICIke05GVF9JTkdSRVNTX1RBQkxFX1RZUEV9IiAiaW5ncmVzcyIKICAgICAgICAgICAgY3JlYXRlX3J1bGVzX2Zvcl9maWx0ZXJpbmcgIiRjb25maWdfaWQiICIkY29uZmlnIiAiJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9IiAiZWdyZXNzIgogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3IgY29uZmlnbWFwX25hbWUgaW4gJChrdWJlY3RsIC0ta3ViZWNvbmZpZz0vZXRjL2NuaS9uZXQuZC9jaWRyLWZpbHRlcmluZy5kL2NpZHItZmlsdGVyaW5nLmt1YmVjb25maWcgZ2V0IGNtIC1sJHtjbmlfc3BlY19uYW1lfSwke2NpZHJfZmlsdGVyaW5nX2NuaV9sYWJlbH0gLW4gJHtwb2RfbmFtZXNwYWNlfSAtbyBqc29ucGF0aD0ne3JhbmdlIC5pdGVtc1sqXX17QC5tZXRhZGF0YS5uYW1lfXsiXG4ifScgfCBoZWFkIC1uIC0xKTsgZG8KICAgICAgICAgICAgX3Byb2Nlc3NfY29uZmlnbWFwICRjb25maWdtYXBfbmFtZSAkcG9kX25hbWVzcGFjZQogICAgICAgIGRvbmUKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0lOR1JFU1NfVEFCTEVfVFlQRX0iICIke05GVF9UQUJMRX0iIG0taW5ncmVzcyBtZXRhIG1hcmsgIiYiIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIHJldHVybikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IG1hcmsgJiAweDAwMDMwMDAwID09IDB4MDAwMzAwMDAgY291bnRlciByZXR1cm4iCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0lOR1JFU1NfVEFCTEVfVFlQRX0iICIke05GVF9UQUJMRX0iIG0taW5ncmVzcyBjb3VudGVyIGRyb3ApIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBkcm9wIgoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHtORlRfRUdSRVNTX1RBQkxFX1RZUEV9IiAiJHtORlRfVEFCTEV9IiBtLWVncmVzcyBtZXRhIG1hcmsgIiYiIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIHJldHVybikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IG1hcmsgJiAweDAwMDMwMDAwID09IDB4MDAwMzAwMDAgY291bnRlciByZXR1cm4iCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0VHUkVTU19UQUJMRV9UWVBFfSIgIiR7TkZUX1RBQkxFfSIgbS1lZ3Jlc3MgY291bnRlciBkcm9wKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZTogZHJvcCIKCiAgICAgICAgZXhpdFdpdGhTdWNjZXNzICIke0NOSV9WRVJTSU9OfSIgIiR7Q05JX1BSRVZfUkVTVUxUfSIKICAgIDs7CgogICAgREVMKQogICAgICAgIGVjaG8gIkRlbGV0ZSAkQ05JX0NPTlRBSU5FUklEIiA+PiAkbG9nRmlsZQogICAgICAgIHJtIC1mIC92YXIvcnVuL25ldG5zLyIkQ05JX0NPTlRBSU5FUklEIgogICAgOzsKCiAgICBWRVJTSU9OKQogICAgICAgIGVjaG8gIntcImNuaVZlcnNpb25cIjpcIjAuMy4xXCIsXCJzdXBwb3J0ZWRWZXJzaW9uc1wiOltcIjAuMS4wXCIsXCIwLjIuMFwiLFwiMC4zLjBcIixcIjAuMy4xXCJdfSIKICAgIDs7CgogICAgKikKICAgICAgICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIlVucmVjb2duaXplZCBDTkkgY29tbWFuZDogJHtDTklfQ09NTUFORH0iCiAgICA7OwoKICAgIGVzYWMKfQoKbWFpbgo="
        securityContext:
          privileged: true
        volumeMounts:
        - name: cni
          mountPath: /host/etc/cni/net.d
        - name: cnibin
          mountPath: /host/opt/cni/bin
        command:
          - /bin/bash
          - -c
          - |
            echo $(SCRIPT) | base64 -d > /host/opt/cni/bin/$(CNI_NAME) &&\
            chmod +x /host/opt/cni/bin/$(CNI_NAME)

            # Inspired by: https://tinyurl.com/y7r2knme
            CIDR_TEMP_KUBECONFIG="/tmp/cidr-filtering.kubeconfig"
            CIDR_KUBECONFIG_FILE_HOST=$(CNI_CONF_DIR)/cidr-filtering.d/cidr-filtering.kubeconfig
            mkdir -p $(CNI_CONF_DIR)/cidr-filtering.d
            

            SERVICE_ACCOUNT_PATH=/var/run/secrets/kubernetes.io/serviceaccount
            KUBE_CA_FILE=${KUBE_CA_FILE:-$SERVICE_ACCOUNT_PATH/ca.crt}
            SERVICEACCOUNT_TOKEN=$(cat $SERVICE_ACCOUNT_PATH/token)
            SKIP_TLS_VERIFY=${SKIP_TLS_VERIFY:-false}

            # Check if we're running as a k8s pod.
            if [ -f "$SERVICE_ACCOUNT_PATH/token" ]; then
              # We're running as a k8d pod - expect some variables.
              if [ -z ${KUBERNETES_SERVICE_HOST} ]; then
                error "KUBERNETES_SERVICE_HOST not set"; exit 1;
              fi
              if [ -z ${KUBERNETES_SERVICE_PORT} ]; then
                error "KUBERNETES_SERVICE_PORT not set"; exit 1;
              fi

              if [ "$SKIP_TLS_VERIFY" == "true" ]; then
                TLS_CFG="insecure-skip-tls-verify: true"
              elif [ -f "$KUBE_CA_FILE" ]; then
                TLS_CFG="certificate-authority-data: $(cat $KUBE_CA_FILE | base64 | tr -d '\n')"
              fi

              # Write a kubeconfig file for the CNI plugin.  Do this
              # to skip TLS verification for now.  We should eventually support
              # writing more complete kubeconfig files. This is only used
              # if the provided CNI network config references it.
              touch $CIDR_TEMP_KUBECONFIG
              chmod ${KUBECONFIG_MODE:-600} $CIDR_TEMP_KUBECONFIG
              # Write the kubeconfig to a temp file first.
              cat > $CIDR_TEMP_KUBECONFIG <<EOF
            # Kubeconfig file for CIDR CNI plugin.
            apiVersion: v1
            kind: Config
            clusters:
            - name: local
              cluster:
                server: ${KUBERNETES_SERVICE_PROTOCOL:-https}://[${KUBERNETES_SERVICE_HOST}]:${KUBERNETES_SERVICE_PORT}
                $TLS_CFG
            users:
            - name: cidr-filtering
              user:
                token: "${SERVICEACCOUNT_TOKEN}"
            contexts:
            - name: cidr-filtering-context
              context:
                cluster: local
                user: cidr-filtering
            current-context: cidr-filtering-context
            EOF

              # Atomically move the temp kubeconfig to its permanent home.
              mv -f $CIDR_TEMP_KUBECONFIG $CIDR_KUBECONFIG_FILE_HOST
            else
              warn "Doesn't look like we're running in a kubernetes environment (no serviceaccount token)"
            fi
      containers:
      - name: cidr-filtering-cni
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        command: ["sleep"]
        args: ["infinity"]
        resources:
          requests:
            cpu: "10m"
            memory: "25Mi"
          limits:
            cpu: "10m"
            memory: "25Mi"
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: cnibin
        hostPath:
          path: /opt/cni/bin
