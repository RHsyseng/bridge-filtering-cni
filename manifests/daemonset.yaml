---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cidr-filtering
subjects:
- kind: ServiceAccount
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cidr-filtering-cni-ds
  namespace: kube-system
  labels:
    tier: node
    app: cidr-filtering-cni
    name: cidr-filtering-cni
spec:
  selector:
    matchLabels:
      name: cidr-filtering-cni
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        tier: node
        app: cidr-filtering-cni
        name: cidr-filtering-cni
    spec:
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      serviceAccountName: cidr-filtering
      initContainers:
      - name: cidr-filtering-cni-copier
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        env:
        - name: CNI_NAME
          value: cidr-filtering-cni
        - name: CNI_CONF_DIR
          value: "/host/etc/cni/net.d"
        - name: SCRIPT
          value: "IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpzdGRpbj0kKGNhdCAvZGV2L3N0ZGluKQpsb2dGaWxlPSIke0xPR0ZJTEU6LS92YXIvbG9nL2NpZHItZmlsdGVyaW5nLWNuaS5sb2d9IgoKQ05JX1ZFUlNJT049IiQoZWNobyAiJHN0ZGluIiB8IGpxIC1yICIuY25pVmVyc2lvbiIpIgpDTklfUFJFVl9SRVNVTFQ9IiQoZWNobyAiJHN0ZGluIiB8IGpxIC1jciAiLnByZXZSZXN1bHQiKSIKCmV4ZWMgMj4+ICRsb2dGaWxlCgpORlRfQlJJREdFX1RBQkxFPWJyaWRnZQpORlRfVEFCTEU9ZmlsdGVyCgpORlRfSU5HUkVTU19DSEFJTj1wcmVyb3V0aW5nCk5GVF9JTkdSRVNTX0hPT0s9cHJlcm91dGluZwoKTkZUX1BPU1RST1VUSU5HX0NIQUlOPXBvc3Ryb3V0aW5nCk5GVF9FR1JFU1NfSE9PSz1wb3N0cm91dGluZwoKZ2V0X29iamVjdCgpIHsKICAgIGxvY2FsIGpzb25fb2JqZWN0PSIkMSIKICAgIGxvY2FsIGpzb25fcGF0aD0iJDIiCiAgICBlY2hvICIkanNvbl9vYmplY3QiIHwganEgLWNyICIkanNvbl9wYXRoIgp9CgpnZXRfYXJyYXlfaXRlbXMoKSB7CiAgICBsb2NhbCBqc29uX29iamVjdD0iJDEiCiAgICBsb2NhbCBqc29uX3BhdGg9IiQyIgogICAgZWNobyAiJGpzb25fb2JqZWN0IiB8IGpxIC1jICRqc29uX3BhdGggfCBqcSAtY3IgIi5bXSIKfQoKZ2V0X2FycmF5X2xlbigpIHsKICAgIGxvY2FsIGpzb25fb2JqZWN0PSIkMSIKICAgIGxvY2FsIGpzb25fcGF0aD0iJDIiCiAgICBlY2hvICIkanNvbl9vYmplY3QiIHwganEgLWMgIiRqc29uX3BhdGgiIHwganEgIi4gfCBsZW5ndGgiCn0KCmZvcl9qc29uX2FycmF5KCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGxvY2FsIGZuPSIkMyIKICAgIGZvciBpdGVtIGluICQoZ2V0X2FycmF5X2l0ZW1zICIkanNvbl9vYmplY3QiICIkanNvbl9wYXRoIik7IGRvCiAgICAgICAgJGZuICRpdGVtCiAgICBkb25lCn0KCmdldF9pcF92ZXJzaW9uKCkgewogICAgbG9jYWwgaXBfYWRkcmVzcz0iJDEiCiAgICBpZiBbWyAiJGlwX2FkZHJlc3MiID1+IC4qOi4qIF1dCiAgICB0aGVuCiAgICAgICAgZWNobyAiaXA2IgogICAgZWxzZQogICAgICAgIGVjaG8gImlwIgogICAgZmkKfQoKY3JlYXRlX3RhYmxlKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGVjaG8gIm5mdCBhZGQgdGFibGUgJHR5cGUgJG5hbWUiIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9uZXRkZXZfYmFzZV9jaGFpbigpIHsKICAgIGxvY2FsIHR5cGU9IiQxIgogICAgbG9jYWwgbmFtZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBsb2NhbCBob29rPSIkNCIKICAgIGxvY2FsIGRldmljZT0iJDUiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiB7IHR5cGUgZmlsdGVyIGhvb2sgJGhvb2sgZGV2aWNlICRkZXZpY2UgcHJpb3JpdHkgLTE7IHBvbGljeSBhY2NlcHQ7IH0iIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9iYXNlX2NoYWluKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGxvY2FsIGNoYWluPSIkMyIKICAgIGxvY2FsIGhvb2s9IiQ0IgogICAgZWNobyAibmZ0IGFkZCBjaGFpbiAkdHlwZSAkbmFtZSAkY2hhaW4geyB0eXBlIGZpbHRlciBob29rICRob29rIHByaW9yaXR5IC0xOyBwb2xpY3kgYWNjZXB0OyB9IiB8IHRlZSAtYSAkbG9nRmlsZQp9CgpjcmVhdGVfY2hhaW4oKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgbG9jYWwgY2hhaW49IiQzIgogICAgZWNobyAibmZ0IGFkZCBjaGFpbiAkdHlwZSAkbmFtZSAkY2hhaW4iIHwgdGVlIC1hICRsb2dGaWxlCn0KCm5mdF9hZGRfcnVsZSgpIHsKICAgIGxvY2FsIHR5cGU9IiQxIgogICAgbG9jYWwgdGFibGU9IiQyIgogICAgbG9jYWwgY2hhaW49IiQzIgogICAgc2V0IC0tICIke0A6NH0iCiAgICBlY2hvICJuZnQgYWRkIHJ1bGUgJHR5cGUgJHRhYmxlICRjaGFpbiAkQCIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX3J1bGVzX2Zvcl9maWx0ZXJpbmcoKSB7CiAgICBsb2NhbCBjb25maWdfaWQ9IiQxIgogICAgbG9jYWwgY29uZmlnPSIkMiIKICAgIGxvY2FsIHRhYmxlX3R5cGU9IiQzIgogICAgbG9jYWwgZGlyZWN0aW9uPSIkNCIKCiAgICBsb2NhbCBtYXRjaF9hZGRyPSJzYWRkciIKICAgIGlmIFtbICIkZGlyZWN0aW9uIiA9PSAiZWdyZXNzIiBdXTsgdGhlbgogICAgICAgIGxvY2FsIG1hdGNoX2FkZHI9ImRhZGRyIgogICAgZmkKICAgIGxvY2FsIG1hdGNoX2lmYWNlPSJpaWZuYW1lIgogICAgaWYgW1sgIiRkaXJlY3Rpb24iID09ICJlZ3Jlc3MiIF1dOyB0aGVuCiAgICAgICAgbWF0Y2hfaWZhY2U9Im9pZm5hbWUiCiAgICBmaQoKICAgIF9jcmVhdGVfZmlsdGVyaW5nX2NoYWluKCkgewogICAgICAgIGxvY2FsIGNvbmZpZ19pZD0iJDEiCiAgICAgICAgbG9jYWwgY29uZmlnPSIkMiIKICAgICAgICBsb2NhbCB0YWJsZV90eXBlPSIkMyIKICAgICAgICBsb2NhbCBkaXJlY3Rpb249IiQ0IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBjaGFpbiAiJHtDTklfSUZOQU1FfSItJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufSIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLSIke2RpcmVjdGlvbn0iICIke21hdGNoX2lmYWNlfSIgIiRDTklfSUZOQU1FIiBjb3VudGVyIGp1bXAgIiR7Q05JX0lGTkFNRX0iLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCAiJHtDTklfSUZOQU1FfSItJHtjb25maWdfaWR9LSR7ZGlyZWN0aW9ufSIKICAgIH0KCiAgICBfY3JlYXRlX3N1Ym5ldF9ydWxlKCkgewogICAgICAgIGxvY2FsIHN1Ym5ldD0kMQogICAgICAgIGlmIFtbICIkKGdldF9vYmplY3QgIiR7c3VibmV0fSIgIi5zdWJuZXQuZXhjZXB0IikiICE9ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBmb3JfanNvbl9hcnJheSAiJHtzdWJuZXR9IiAiLnN1Ym5ldC5leGNlcHQiIF9kcm9wX2lwCiAgICAgICAgZmkKCiAgICAgICAgaWYgW1sgIiQoZ2V0X29iamVjdCAiJHtzdWJuZXR9IiAiLnN1Ym5ldC5jaWRyIikiID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgImNpZHIgbXVzdCBiZSBzcGVjaWZpZWQuIgogICAgICAgIGZpCiAgICAgICAgX2FjY2VwdF9jaWRyICIke3N1Ym5ldH0iCiAgICB9CgogICAgX2Ryb3BfaXAoKSB7CiAgICAgICAgbG9jYWwgaXA9IiQxIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXN1Ym5ldHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJChnZXRfaXBfdmVyc2lvbiAiJHtpcH0iKSAke21hdGNoX2FkZHJ9ICR7aXB9IGNvdW50ZXIgZHJvcCkKICAgIH0KCiAgICBfYWNjZXB0X2NpZHIoKSB7CiAgICAgICAgbG9jYWwgc3VibmV0PSIkMSIKICAgICAgICBsb2NhbCBjaWRyPSQoZWNobyAiJHtzdWJuZXR9IiB8IGpxIC1yICIuc3VibmV0LmNpZHIiKQogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXN1Ym5ldHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJChnZXRfaXBfdmVyc2lvbiAiJHtjaWRyfSIpICR7bWF0Y2hfYWRkcn0gJHtjaWRyfSBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWFyayBvciAweDIwMDAwKQogICAgfQoKICAgIF9hY2NlcHRfcG9ydCgpIHsKICAgICAgICBsb2NhbCBwb3J0cz0iJDEiCiAgICAgICAgbG9jYWwgcG9ydD0kKGVjaG8gIiRwb3J0cyIgfCBqcSAtciAiLnBvcnQiKQogICAgICAgIGxvY2FsIHByb3RvY29sPSQoZWNobyAiJHBvcnRzIiB8IGpxIC1yICIucHJvdG9jb2wiKQoKICAgICAgICBpZiBbWyAiJHBvcnQiID09ICJudWxsIiB8fCAiJHByb3RvY29sIiA9PSAibnVsbCIgfHwgIiRwb3J0IiA9PSAiIiB8fCAiJHByb3RvY29sIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIlBvcnQgYW5kIHByb3RvY29sIG11c3QgYmUgc3BlY2lmaWVkLiIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0ke2NvbmZpZ19pZH0tJHtkaXJlY3Rpb259LXBvcnRzICR7bWF0Y2hfaWZhY2V9ICRDTklfSUZOQU1FICR7cHJvdG9jb2wsLH0gZHBvcnQgJHtwb3J0fSBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWV0YSBtYXJrICJ8IiAweDAwMDEwMDAwKQogICAgICAgIGZpCiAgICB9CgogICAgbG9jYWwgaXNfZmlsdGVyaW5nX2NoYWluX2NyZWF0ZWQ9ZmFsc2UKICAgICMgaGFuZGxlIGlwIHN1Ym5ldAogICAgaWYgW1sgJChlY2hvICIkY29uZmlnIiB8IGpxIC1yICIuJHtkaXJlY3Rpb259LnN1Ym5ldHMiKSAhPSAibnVsbCIgXV07IHRoZW4KICAgICAgICBfY3JlYXRlX2ZpbHRlcmluZ19jaGFpbiAiJHtjb25maWdfaWR9IiAiJHtjb25maWd9IiAiJHt0YWJsZV90eXBlfSIgIiR7ZGlyZWN0aW9ufSIKICAgICAgICBpc19maWx0ZXJpbmdfY2hhaW5fY3JlYXRlZD10cnVlCgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIgY291bnRlciBqdW1wICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cyIKCiAgICAgICAgaWYgW1sgJChnZXRfYXJyYXlfbGVuICIkY29uZmlnIiAiLiR7ZGlyZWN0aW9ufS5zdWJuZXRzIikgPT0gMCBdXTsgdGhlbgogICAgICAgICAgICAjIGV4YW1wbGU6ICBpbmdyZXNzOiB7c3VibmV0czogW119ICA9PiB0cmFuc2xhdGVzIHRvIGFsbG93IGFsbCBzdWJuZXRzCiAgICAgICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzIGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtYXJrIG9yIDB4MjAwMDApIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFsbG93IGFsbCBMMyB0cmFmZmljIgogICAgICAgIGVsc2UKICAgICAgICAgICAgZm9yX2pzb25fYXJyYXkgIiRjb25maWciICIuJHtkaXJlY3Rpb259LnN1Ym5ldHMiIF9jcmVhdGVfc3VibmV0X3J1bGUKICAgICAgICBmaQogICAgZmkKCiAgICAjIGhhbmRsZSBwb3J0cwogICAgaWYgW1sgJChlY2hvICIkY29uZmlnIiB8IGpxIC1yICIuJHtkaXJlY3Rpb259LnBvcnRzIikgIT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgaWYgW1sgIiRpc19maWx0ZXJpbmdfY2hhaW5fY3JlYXRlZCIgPT0gZmFsc2UgXV07IHRoZW4KICAgICAgICAgICAgX2NyZWF0ZV9maWx0ZXJpbmdfY2hhaW4gIiR7Y29uZmlnX2lkfSIgIiR7Y29uZmlnfSIgIiR7dGFibGVfdHlwZX0iICIke2RpcmVjdGlvbn0iCiAgICAgICAgICAgIGlzX2ZpbHRlcmluZ19jaGFpbl9jcmVhdGVkPXRydWUKICAgICAgICBmaQoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9jaGFpbiAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgY2hhaW4gIiR7Q05JX0lGTkFNRX0iLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSIgY291bnRlciBqdW1wICIke0NOSV9JRk5BTUV9Ii0iJHtjb25maWdfaWR9Ii0iJHtkaXJlY3Rpb259Ii1wb3J0cykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGp1bXAgIiR7Q05JX0lGTkFNRX0iLSIke2NvbmZpZ19pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzIgogICAgICAgIAogICAgICAgIGlmIFtbICQoZ2V0X2FycmF5X2xlbiAiJGNvbmZpZyIgIi4ke2RpcmVjdGlvbn0ucG9ydHMiKSA9PSAwIF1dOyB0aGVuCiAgICAgICAgICAgICMgZXhhbXBsZTogICJlZ3Jlc3MiOiB7InBvcnRzIjogW119ICA9PiB0cmFuc2xhdGVzIHRvIGFsbG93IGFsbCBwb3J0cwogICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSAiJHtDTklfSUZOQU1FfSItIiR7Y29uZmlnX2lkfSItIiR7ZGlyZWN0aW9ufSItcG9ydHMgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAifCIgMHgwMDAxMDAwMCkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWxsb3cgYWxsIEw0IHRyYWZmaWMgd2hlbiBub3QgZXhwbGljaXQgY29uZmlnIHByb3ZpZGVkIgogICAgICAgIGVsc2UKICAgICAgICAgICAgZm9yX2pzb25fYXJyYXkgIiRjb25maWciICIuJHtkaXJlY3Rpb259LnBvcnRzIiBfYWNjZXB0X3BvcnQKICAgICAgICBmaQogICAgZmkKfQoKZXhpdFdpdGhFcnJvcigpIHsKICAgIGxvY2FsIGNuaV92ZXJzaW9uPSIkMSIKICAgIGxvY2FsIG1lc3NhZ2U9IiR7MjotIiJ9IgogICAgbG9jYWwgZGV0YWlscz0iJHszOi0iIn0iCiAgICBlY2hvICJ7XCJjbmlWZXJzaW9uXCI6IFwiJHtjbmlfdmVyc2lvbn1cIixcIm1zZ1wiOlwiJHttZXNzYWdlfVwiLFwiY29kZVwiOjEwMSxcImRldGFpbHNcIjpcIiR7ZGV0YWlsc31cIn0iCiAgICBleGl0IDEKfQoKZXhpdFdpdGhTdWNjZXNzKCkgewogICAgbG9jYWwgY25pX3ZlcnNpb249IiQxIgogICAgbG9jYWwgcHJldl9yZXN1bHQ9IiQyIgogICAgaWYgW1sgIiRwcmV2X3Jlc3VsdCIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZWNobyAie1wiY25pVmVyc2lvblwiOiBcIiRjbmlfdmVyc2lvblwifSIKICAgIGVsc2UKICAgICAgICBlY2hvICIkcHJldl9yZXN1bHQiCiAgICBmaQogICAgZXhpdCAwCn0KCm1haW4oKSB7CiAgICBjYXNlICRDTklfQ09NTUFORCBpbgogICAgQUREKQogICAgICAgIGVjaG8gIkNOSV9ORVROUzogJENOSV9ORVROUyIgPj4gJGxvZ0ZpbGUKICAgICAgICBlY2hvICJDTklfQ09OVEFJTkVSSUQ6ICRDTklfQ09OVEFJTkVSSUQiID4+ICRsb2dGaWxlCiAgICAgICAgZWNobyAiU1RESU46ICRzdGRpbiIgPj4gJGxvZ0ZpbGUKICAgICAgICBlY2hvICJDTklfQVJHUzogJENOSV9BUkdTIiA+PiAkbG9nRmlsZQoKICAgICAgICBsb2NhbCBjaWRyX2ZpbHRlcmluZ19jbmlfbGFiZWw9ImNpZHItZmlsdGVyaW5nLWNuaSIKICAgICAgICBsb2NhbCBjbmlfc3BlY19uYW1lPSQoZWNobyAiJHN0ZGluIiB8IGpxIC1yICIubmFtZSIpCiAgICAgICAgbG9jYWwgcG9kX25hbWVzcGFjZT0iIgoKICAgICAgICBmb3IgaSBpbiAke0NOSV9BUkdTLy87LyB9CiAgICAgICAgZG8KICAgICAgICAgICAgY2FzZSAkaSBpbgogICAgICAgICAgICAiSzhTX1BPRF9OQU1FU1BBQ0U9IiopCiAgICAgICAgICAgICAgICBwb2RfbmFtZXNwYWNlPSQoZWNobyAkaSB8IGF3ayAtRic9JyAne3ByaW50ICQyfScpCiAgICAgICAgICAgICAgICBpZiBbWyAiJHBvZF9uYW1lc3BhY2UiID09ICIiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gcGFyc2UgcG9kIG5hbWVzcGFjZSBmcm9tIENOSV9BUkdTIgogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgOzsKICAgICAgICAgICAgZXNhYwogICAgICAgIGRvbmUKCiAgICAgICAgbWtkaXIgLXAgL3Zhci9ydW4vbmV0bnMvCiAgICAgICAgbG4gLXNmVCAiJENOSV9ORVROUyIgL3Zhci9ydW4vbmV0bnMvIiR7Q05JX0NPTlRBSU5FUklEfSIKCiAgICAgICAgIyBDaGVjayBBUEkgYWNjZXNzCiAgICAgICAga3ViZWN0bCAtLWt1YmVjb25maWc9L2V0Yy9jbmkvbmV0LmQvY2lkci1maWx0ZXJpbmcuZC9jaWRyLWZpbHRlcmluZy5rdWJlY29uZmlnIGFwaS1yZXNvdXJjZXMgPiAvZGV2L251bGwgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gcmVhY2gga3ViZXJuZXRlcyBBUEkgc2VydmVyIgoKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV90YWJsZSAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gY3JlYXRlIHRhYmxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgdGFibGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0iCgogICAgICAgICMgY3JlYXRlIGJhc2UgY2hhaW5zCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfYmFzZV9jaGFpbiAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSAke05GVF9JTkdSRVNTX0NIQUlOfSAke05GVF9JTkdSRVNTX0hPT0t9KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBjcmVhdGUgYmFzZSBjaGFpbiAke05GVF9JTkdSRVNTX0NIQUlOfSIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9iYXNlX2NoYWluICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICR7TkZUX1BPU1RST1VUSU5HX0NIQUlOfSAke05GVF9FR1JFU1NfSE9PS30pIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGNyZWF0ZSBicmlkZ2UgYmFzZSBjaGFpbiAke05GVF9QT1NUUk9VVElOR19DSEFJTn0iCgogICAgICAgICMgZmlsdGVyIGNoYWlucwogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICIke0NOSV9JRk5BTUV9Ii1pbmdyZXNzKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgY2hhaW4gIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChjcmVhdGVfY2hhaW4gJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gIiR7Q05JX0lGTkFNRX0iLWVncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIGNoYWluICIke0NOSV9JRk5BTUV9Ii1lZ3Jlc3MiCgogICAgICAgICMgc2V0dXAgcHJlcm91dGluZyBjaGFpbgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7TkZUX0JSSURHRV9UQUJMRX0gJHtORlRfVEFCTEV9ICR7TkZUX0lOR1JFU1NfQ0hBSU59IGV0aGVyIHR5cGUgYXJwIGNvdW50ZXIgYWNjZXB0KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhcnAgZm9yIGluZ3Jlc3MiCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gJHtORlRfSU5HUkVTU19DSEFJTn0gaWlmbmFtZSAkQ05JX0lGTkFNRSBjb3VudGVyIGp1bXAgIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wICIke0NOSV9JRk5BTUV9Ii1pbmdyZXNzIgoKICAgICAgICAjIHNldHVwIHBvc3Ryb3V0aW5nIGNoYWluCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgJHtORlRfQlJJREdFX1RBQkxFfSAke05GVF9UQUJMRX0gJHtORlRfUE9TVFJPVVRJTkdfQ0hBSU59IGV0aGVyIHR5cGUgYXJwIGNvdW50ZXIgYWNjZXB0KSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhbGxvdyBhcnAgZm9yIGVncmVzcyIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9CUklER0VfVEFCTEV9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gb2lmbmFtZSAkQ05JX0lGTkFNRSBjb3VudGVyIGp1bXAgIiR7Q05JX0lGTkFNRX0iLWVncmVzcykgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGp1bXAgIiR7Q05JX0lGTkFNRX0iLWVncmVzcyIKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0JSSURHRV9UQUJMRX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii1lZ3Jlc3MgY291bnRlciBtZXRhIG1hcmsgc2V0IG1ldGEgbWFyayAiJiIgMHhmZmZjZmZmZikgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9CUklER0VfVEFCTEV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItaW5ncmVzcyBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWV0YSBtYXJrICImIiAweGZmZmNmZmZmKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZTogc2V0IG1ldGEgbWFyayAmIDB4ZmZmY2ZmZmYiCgogICAgICAgIF9wcm9jZXNzX2NvbmZpZ21hcCgpIHsKICAgICAgICAgICAgbG9jYWwgY29uZmlnbWFwX25hbWU9IiQxIgogICAgICAgICAgICBsb2NhbCBjb25maWdtYXBfbmFtZXNwYWNlPSIkMiIKICAgICAgICAgICAgbG9jYWwgY29uZmlnX2lkPSIkKGVjaG8gIiR7Y29uZmlnbWFwX25hbWV9JHtjb25maWdtYXBfbmFtZXNwYWNlfSIgfCBzaGExc3VtICkiCiAgICAgICAgICAgIGNvbmZpZ19pZD0iJHtjb25maWdfaWQ6MDo1fSIgIyB1c2UgZmlyc3QgNSBjaGFyYWN0ZXJzIHRvIGlkZW50aWZ5IGNvbmZpZ3VyYXRpb24gc3BlY2lmaWVkIGluIGEgY29uZmlnbWFwCgogICAgICAgICAgICAjIHRoZSBqc29uIGNvbmZpZyBpbiBjb25maWdtYXAgaXMgZXNjYXBlZCB3aGVuIHRoZSBjb25maWdtYXAgaXRzZWxmIGlzIG9idGFpbmVkIGluIGpzb24uIFRvIGJlIGFibGUgdG8gd29yayB3aXRoIGl0IHdpdGgganEsIHdlIG5lZWQgdG8gcmVtb3ZlICdcbicsICdcJycsIHNwYWNlcyBhbmQgbGVhZGluZy90cmFpbGluZyBjaGFyYWN0ZXIgKHdoaWNoIGlzIGFuIGFwb3N0cm9waGUpCiAgICAgICAgICAgIGxvY2FsIGNvbmZpZz0kKGt1YmVjdGwgLS1rdWJlY29uZmlnPS9ldGMvY25pL25ldC5kL2NpZHItZmlsdGVyaW5nLmQvY2lkci1maWx0ZXJpbmcua3ViZWNvbmZpZyBnZXQgY20gJHtjb25maWdtYXBfbmFtZX0gLW4gJHtjb25maWdtYXBfbmFtZXNwYWNlfSAtbyBqc29uIHwganEgLWMgJy5kYXRhLiJjb25maWcuanNvbiInIHwgc2VkICdzI1xcbiMjZztzI1xcIyNnO3MjICMjZztzL14uLy87cy8uJC8vJykKCiAgICAgICAgICAgIGNyZWF0ZV9ydWxlc19mb3JfZmlsdGVyaW5nICIkY29uZmlnX2lkIiAiJGNvbmZpZyIgIiR7TkZUX0JSSURHRV9UQUJMRX0iICJpbmdyZXNzIgogICAgICAgICAgICBjcmVhdGVfcnVsZXNfZm9yX2ZpbHRlcmluZyAiJGNvbmZpZ19pZCIgIiRjb25maWciICIke05GVF9CUklER0VfVEFCTEV9IiAiZWdyZXNzIgogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3IgY29uZmlnbWFwX25hbWUgaW4gJChrdWJlY3RsIC0ta3ViZWNvbmZpZz0vZXRjL2NuaS9uZXQuZC9jaWRyLWZpbHRlcmluZy5kL2NpZHItZmlsdGVyaW5nLmt1YmVjb25maWcgZ2V0IGNtIC1sJHtjbmlfc3BlY19uYW1lfSwke2NpZHJfZmlsdGVyaW5nX2NuaV9sYWJlbH0gLW4gJHtwb2RfbmFtZXNwYWNlfSAtbyBqc29ucGF0aD0ne3JhbmdlIC5pdGVtc1sqXX17QC5tZXRhZGF0YS5uYW1lfXsiXG4ifScgfCBoZWFkIC1uIC0xKTsgZG8KICAgICAgICAgICAgX3Byb2Nlc3NfY29uZmlnbWFwICRjb25maWdtYXBfbmFtZSAkcG9kX25hbWVzcGFjZQogICAgICAgIGRvbmUKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0JSSURHRV9UQUJMRX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii1pbmdyZXNzIG1ldGEgbWFyayAiJiIgMHgwMDAzMDAwMCA9PSAweDAwMDMwMDAwIGNvdW50ZXIgcmV0dXJuKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZTogbWFyayAmIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIHJldHVybiIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHtORlRfQlJJREdFX1RBQkxFfSIgIiR7TkZUX1RBQkxFfSIgIiR7Q05JX0lGTkFNRX0iLWluZ3Jlc3MgY291bnRlciBkcm9wKSB8fCBleGl0V2l0aEVycm9yICIke0NOSV9WRVJTSU9OfSIgIkZhaWxlZCB0byBhZGQgcnVsZTogZHJvcCIKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX0JSSURHRV9UQUJMRX0iICIke05GVF9UQUJMRX0iICIke0NOSV9JRk5BTUV9Ii1lZ3Jlc3MgbWV0YSBtYXJrICImIiAweDAwMDMwMDAwID09IDB4MDAwMzAwMDAgY291bnRlciByZXR1cm4pIHx8IGV4aXRXaXRoRXJyb3IgIiR7Q05JX1ZFUlNJT059IiAiRmFpbGVkIHRvIGFkZCBydWxlOiBtYXJrICYgMHgwMDAzMDAwMCA9PSAweDAwMDMwMDAwIGNvdW50ZXIgcmV0dXJuIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9CUklER0VfVEFCTEV9IiAiJHtORlRfVEFCTEV9IiAiJHtDTklfSUZOQU1FfSItZWdyZXNzIGNvdW50ZXIgZHJvcCkgfHwgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGRyb3AiCgogICAgICAgIGV4aXRXaXRoU3VjY2VzcyAiJHtDTklfVkVSU0lPTn0iICIke0NOSV9QUkVWX1JFU1VMVH0iCiAgICA7OwoKICAgIERFTCkKICAgICAgICBlY2hvICJEZWxldGUgJENOSV9DT05UQUlORVJJRCIgPj4gJGxvZ0ZpbGUKICAgICAgICBybSAtZiAvdmFyL3J1bi9uZXRucy8iJENOSV9DT05UQUlORVJJRCIKICAgIDs7CgogICAgVkVSU0lPTikKICAgICAgICBlY2hvICJ7XCJjbmlWZXJzaW9uXCI6XCIwLjMuMVwiLFwic3VwcG9ydGVkVmVyc2lvbnNcIjpbXCIwLjEuMFwiLFwiMC4yLjBcIixcIjAuMy4wXCIsXCIwLjMuMVwiXX0iCiAgICA7OwoKICAgICopCiAgICAgICAgZXhpdFdpdGhFcnJvciAiJHtDTklfVkVSU0lPTn0iICJVbnJlY29nbml6ZWQgQ05JIGNvbW1hbmQ6ICR7Q05JX0NPTU1BTkR9IgogICAgOzsKCiAgICBlc2FjCn0KCm1haW4K"
        securityContext:
          privileged: true
        volumeMounts:
        - name: cni
          mountPath: /host/etc/cni/net.d
        - name: cnibin
          mountPath: /host/opt/cni/bin
        command:
          - /bin/bash
          - -c
          - |
            echo $(SCRIPT) | base64 -d > /host/opt/cni/bin/$(CNI_NAME) &&\
            chmod +x /host/opt/cni/bin/$(CNI_NAME)

            # Inspired by: https://tinyurl.com/y7r2knme
            CIDR_TEMP_KUBECONFIG="/tmp/cidr-filtering.kubeconfig"
            CIDR_KUBECONFIG_FILE_HOST=$(CNI_CONF_DIR)/cidr-filtering.d/cidr-filtering.kubeconfig
            mkdir -p $(CNI_CONF_DIR)/cidr-filtering.d
            

            SERVICE_ACCOUNT_PATH=/var/run/secrets/kubernetes.io/serviceaccount
            KUBE_CA_FILE=${KUBE_CA_FILE:-$SERVICE_ACCOUNT_PATH/ca.crt}
            SERVICEACCOUNT_TOKEN=$(cat $SERVICE_ACCOUNT_PATH/token)
            SKIP_TLS_VERIFY=${SKIP_TLS_VERIFY:-false}

            # Check if we're running as a k8s pod.
            if [ -f "$SERVICE_ACCOUNT_PATH/token" ]; then
              # We're running as a k8d pod - expect some variables.
              if [ -z ${KUBERNETES_SERVICE_HOST} ]; then
                error "KUBERNETES_SERVICE_HOST not set"; exit 1;
              fi
              if [ -z ${KUBERNETES_SERVICE_PORT} ]; then
                error "KUBERNETES_SERVICE_PORT not set"; exit 1;
              fi

              if [ "$SKIP_TLS_VERIFY" == "true" ]; then
                TLS_CFG="insecure-skip-tls-verify: true"
              elif [ -f "$KUBE_CA_FILE" ]; then
                TLS_CFG="certificate-authority-data: $(cat $KUBE_CA_FILE | base64 | tr -d '\n')"
              fi

              # Write a kubeconfig file for the CNI plugin.  Do this
              # to skip TLS verification for now.  We should eventually support
              # writing more complete kubeconfig files. This is only used
              # if the provided CNI network config references it.
              touch $CIDR_TEMP_KUBECONFIG
              chmod ${KUBECONFIG_MODE:-600} $CIDR_TEMP_KUBECONFIG
              # Write the kubeconfig to a temp file first.
              cat > $CIDR_TEMP_KUBECONFIG <<EOF
            # Kubeconfig file for CIDR CNI plugin.
            apiVersion: v1
            kind: Config
            clusters:
            - name: local
              cluster:
                server: ${KUBERNETES_SERVICE_PROTOCOL:-https}://[${KUBERNETES_SERVICE_HOST}]:${KUBERNETES_SERVICE_PORT}
                $TLS_CFG
            users:
            - name: cidr-filtering
              user:
                token: "${SERVICEACCOUNT_TOKEN}"
            contexts:
            - name: cidr-filtering-context
              context:
                cluster: local
                user: cidr-filtering
            current-context: cidr-filtering-context
            EOF

              # Atomically move the temp kubeconfig to its permanent home.
              mv -f $CIDR_TEMP_KUBECONFIG $CIDR_KUBECONFIG_FILE_HOST
            else
              warn "Doesn't look like we're running in a kubernetes environment (no serviceaccount token)"
            fi
      containers:
      - name: cidr-filtering-cni
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        command: ["sleep"]
        args: ["infinity"]
        resources:
          requests:
            cpu: "10m"
            memory: "25Mi"
          limits:
            cpu: "10m"
            memory: "25Mi"
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: cnibin
        hostPath:
          path: /opt/cni/bin
